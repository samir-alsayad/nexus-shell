# --- Nexus-Shell TMUX Configuration ---

# === Performance ===
set -g mouse on
setw -g aggressive-resize on
set -g status-interval 2
set -s escape-time 0

# === True Color Support ===
set -g default-terminal "tmux-256color"
set -ga terminal-overrides ",xterm-256color:Tc"

# === Theme: Nexus Cyber ===
set -g status-bg "#0a0e14"
set -g status-fg cyan
set -g pane-border-style fg="#1a1f2c"
set -g pane-active-border-style fg=cyan
set -g message-style bg="#0a0e14",fg=yellow

# === Pane Titles ===
set -g pane-border-status top
set -g pane-border-format " #P: #{pane_title} "

# === Status Bar ===
set -g @nexus_mode "INSERT"
set -g status-left-length 60
set -g status-left "#{?#{==:#{@nexus_mode},NORMAL},#[bg=yellow]#[fg=black]#[bold] NORMAL ,#[fg=cyan,bold] NEXUS }#[fg=white]| "
set -g status-right-length 60
set -g status-right "#[fg=cyan]#{pane_title} #[fg=white]| #[fg=green]%H:%M"

# ============================================================
# PANE SWITCHING KEYBINDS
# ============================================================
# Multiple options provided - use what works for your terminal

# --- Option 1: Alt+Key (works if terminal passes Alt/Option as Meta) ---
# Note: May conflict with apps inside panes (nvim, etc.)
# Logic: Focus by index, with fallbacks for dynamic layouts
bind-key -n M-n run-shell "tmux select-pane -t \${PX_NEXUS_TREE_PANE:-0}"
bind-key -n M-p run-shell "tmux select-pane -t \${PX_NEXUS_PARALLAX_PANE:-1}"
bind-key -n M-e run-shell "tmux select-pane -t \${PX_NEXUS_EDITOR_PANE:-2}"
bind-key -n M-t run-shell "tmux select-pane -t \${PX_NEXUS_TERMINAL_PANE:-3}"
bind-key -n M-c run-shell "tmux select-pane -t \${PX_NEXUS_CHAT_PANE:-4}"

# Supporting legacy 1-5 numbering (robust versions)
bind-key -n M-1 run-shell "tmux select-pane -t \${PX_NEXUS_TREE_PANE:-0}"
bind-key -n M-2 run-shell "tmux select-pane -t \${PX_NEXUS_PARALLAX_PANE:-1}"
bind-key -n M-3 run-shell "tmux select-pane -t \${PX_NEXUS_EDITOR_PANE:-2}"
bind-key -n M-4 run-shell "tmux select-pane -t \${PX_NEXUS_TERMINAL_PANE:-3}"
bind-key -n M-5 run-shell "tmux select-pane -t \${PX_NEXUS_CHAT_PANE:-4}"

# --- Alt+brackets for prev/next pane (less likely to conflict) ---
bind-key -n M-[ select-pane -t :.-
bind-key -n M-] select-pane -t :.+

# --- Alt+hjkl for directional (may work better than numbers) ---
bind-key -n M-h select-pane -L
bind-key -n M-j select-pane -D
bind-key -n M-k select-pane -U
bind-key -n M-l select-pane -R

# --- Option 2: Prefix + Number (always works: Ctrl+b then 1/2/3/4) ---
bind-key 1 select-pane -t :.0
bind-key 2 select-pane -t :.1
bind-key 3 select-pane -t :.2
bind-key 4 select-pane -t :.3

# --- Option 3: Quick pane switching with Ctrl+g then hjkl ---
# Press Ctrl+g, then h/j/k/l to switch panes (fast two-key combo)
bind-key -n C-g switch-client -T paneswitch
bind-key -T paneswitch h select-pane -L
bind-key -T paneswitch l select-pane -R
bind-key -T paneswitch k select-pane -U
bind-key -T paneswitch j select-pane -D
bind-key -T paneswitch 1 select-pane -t :.0
bind-key -T paneswitch 2 select-pane -t :.1
bind-key -T paneswitch 3 select-pane -t :.2
bind-key -T paneswitch 4 select-pane -t :.3
bind-key -T paneswitch n select-pane -t :.0
bind-key -T paneswitch e select-pane -t :.1
bind-key -T paneswitch t select-pane -t :.2
bind-key -T paneswitch c select-pane -t :.3

# --- Option 4: Backtick prefix for quick access ---
# Uncomment to use ` as secondary prefix (`` to type literal backtick)
# set -g prefix2 `
# bind-key ` send-prefix -2
# bind-key -T prefix2 1 select-pane -t :.0
# bind-key -T prefix2 2 select-pane -t :.1

# ============================================================
# CORE KEYBINDS
# ============================================================

# --- Swap Mode (Ctrl+Space) - Toggle Editor/Render ---
bind-key -n C-Space run-shell "$HOME/.config/nexus-shell/scripts/swap.sh"

# --- Swap Tree (Alt+G) - Toggle Tree/Git ---
bind-key -n M-g run-shell "$HOME/.config/nexus-shell/scripts/tree_swap.sh"

# --- Command Prompt (Ctrl+\) ---
bind-key -n C-\\ command-prompt -p ":" "run-shell '$HOME/.config/nexus-shell/scripts/dispatch.sh %%'"

# --- Parallax Dashboard (Alt+P) ---
bind-key -n M-p run-shell "tmux select-pane -t \${PX_NEXUS_PARALLAX_PANE:-1}"

# --- Parallax Audit/Targeting (Alt+A) ---
bind-key -n M-a run-shell "tmux send-keys -t \${PX_NEXUS_PARALLAX_PANE:-1} 'px-audit' Enter && tmux select-pane -t \${PX_NEXUS_PARALLAX_PANE:-1}"

# --- Quick Actions (Ctrl+A) ---
bind-key -n C-A run-shell "$HOME/.config/nexus-shell/scripts/dispatch.sh actions"

# ============================================================
# NORMAL MODE (Alt+Escape to enter, Escape to exit)
# ============================================================
bind-key -n M-Escape set -g @nexus_mode "NORMAL" \; switch-client -T nexus \; refresh-client -S

# Nexus key table (active in NORMAL mode)
bind-key -T nexus Escape set -g @nexus_mode "INSERT" \; switch-client -T root \; refresh-client -S

# Navigation (NORMAL mode) - single letter keys
bind-key -T nexus n run-shell "tmux select-pane -t \${PX_NEXUS_TREE_PANE:-0}"
bind-key -T nexus p run-shell "tmux select-pane -t \${PX_NEXUS_PARALLAX_PANE:-1}"
bind-key -T nexus e run-shell "tmux select-pane -t \${PX_NEXUS_EDITOR_PANE:-2}"
bind-key -T nexus t run-shell "tmux select-pane -t \${PX_NEXUS_TERMINAL_PANE:-3}"
bind-key -T nexus c run-shell "tmux select-pane -t \${PX_NEXUS_CHAT_PANE:-4}"

# Also support 12345 in normal mode
bind-key -T nexus 1 run-shell "tmux select-pane -t \${PX_NEXUS_TREE_PANE:-0}"
bind-key -T nexus 2 run-shell "tmux select-pane -t \${PX_NEXUS_PARALLAX_PANE:-1}"
bind-key -T nexus 3 run-shell "tmux select-pane -t \${PX_NEXUS_EDITOR_PANE:-2}"
bind-key -T nexus 4 run-shell "tmux select-pane -t \${PX_NEXUS_TERMINAL_PANE:-3}"
bind-key -T nexus 5 run-shell "tmux select-pane -t \${PX_NEXUS_CHAT_PANE:-4}"

# Directional in NORMAL mode
bind-key -T nexus h run-shell "$NEXUS_CONFIG/scripts/plane_nav.sh left"
bind-key -T nexus j run-shell "$NEXUS_CONFIG/scripts/plane_nav.sh down"
bind-key -T nexus k run-shell "$NEXUS_CONFIG/scripts/plane_nav.sh up"
bind-key -T nexus l run-shell "$NEXUS_CONFIG/scripts/plane_nav.sh right"

# Resizing (NORMAL mode, Shift + H/J/K/L)
bind-key -T nexus H resize-pane -L 5
bind-key -T nexus L resize-pane -R 5
bind-key -T nexus K resize-pane -U 3
bind-key -T nexus J resize-pane -D 3

# Quick Actions (NORMAL mode)
bind-key -T nexus q run-shell "$HOME/.config/nexus-shell/scripts/dispatch.sh q"
bind-key -T nexus v run-shell "$HOME/.config/nexus-shell/scripts/swap.sh"
bind-key -T nexus ? display-message "Panes: n/1=tree e/2=editor t/3=term c/4=chat | hjkl=move | HJKL=resize | v=swap q=quit"

# Return to INSERT after Enter
bind-key -T nexus Enter set -g @nexus_mode "INSERT" \; switch-client -T root \; refresh-client -S
